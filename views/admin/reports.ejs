<%- include("../partials/header") %>
<%
  const selectedPeriod = typeof period === "string" ? period : "all";
  const safeCharts = charts || { status: [0, 0, 0, 0], methods: { labels: [], values: [] }, daily: { labels: [], values: [] } };
%>
<section class="admin-page">
  <header class="admin-page-header">
    <div>
      <h1><i class="bi bi-bar-chart-line icon" aria-hidden="true"></i> Relatorios</h1>
      <p class="muted">Indicadores operacionais com filtros por periodo.</p>
    </div>
    <div class="admin-page-actions report-filters">
      <a class="btn btn-outline btn-sm <%= selectedPeriod === 'all' ? 'active-filter' : '' %>" href="/admin/relatorios?period=all">Todos</a>
      <a class="btn btn-outline btn-sm <%= selectedPeriod === 'day' ? 'active-filter' : '' %>" href="/admin/relatorios?period=day">Dia</a>
      <a class="btn btn-outline btn-sm <%= selectedPeriod === 'week' ? 'active-filter' : '' %>" href="/admin/relatorios?period=week">Semana</a>
      <a class="btn btn-outline btn-sm <%= selectedPeriod === 'month' ? 'active-filter' : '' %>" href="/admin/relatorios?period=month">Mes</a>
      <a class="btn btn-outline btn-sm <%= selectedPeriod === 'year' ? 'active-filter' : '' %>" href="/admin/relatorios?period=year">Ano</a>
    </div>
  </header>

  <div class="admin-stats-grid admin-stats-grid-ref">
    <article class="admin-stat admin-stat-blue">
      <p class="stat-label"><i class="bi bi-calendar2-check icon" aria-hidden="true"></i> Total Reservas</p>
      <p class="stat-value"><%= reservationsByStatus.total %></p>
    </article>
    <article class="admin-stat admin-stat-navy">
      <p class="stat-label"><i class="bi bi-hourglass-split icon" aria-hidden="true"></i> Pendentes</p>
      <p class="stat-value"><%= reservationsByStatus.pending %></p>
    </article>
    <article class="admin-stat admin-stat-green">
      <p class="stat-label"><i class="bi bi-check2-circle icon" aria-hidden="true"></i> Confirmadas</p>
      <p class="stat-value"><%= reservationsByStatus.confirmed %></p>
    </article>
    <article class="admin-stat admin-stat-gold">
      <p class="stat-label"><i class="bi bi-stars icon" aria-hidden="true"></i> Concluidas</p>
      <p class="stat-value"><%= reservationsByStatus.completed %></p>
    </article>
    <article class="admin-stat admin-stat-pink">
      <p class="stat-label"><i class="bi bi-x-circle icon" aria-hidden="true"></i> Canceladas</p>
      <p class="stat-value"><%= reservationsByStatus.cancelled %></p>
    </article>
    <article class="admin-stat admin-stat-orange">
      <p class="stat-label"><i class="bi bi-cash-stack icon" aria-hidden="true"></i> Receita Total</p>
      <p class="stat-value"><%= Number(revenue.total || 0).toLocaleString("pt-MZ") %> MT</p>
    </article>
  </div>

  <section class="report-grid">
    <article class="card report-card">
      <h2><i class="bi bi-pie-chart icon" aria-hidden="true"></i> Status das Reservas</h2>
      <canvas id="statusChart" height="220"></canvas>
    </article>
    <article class="card report-card">
      <h2><i class="bi bi-wallet2 icon" aria-hidden="true"></i> Receita por Metodo</h2>
      <canvas id="methodChart" height="220"></canvas>
    </article>
    <article class="card report-card report-card-wide">
      <h2><i class="bi bi-graph-up-arrow icon" aria-hidden="true"></i> Tendencia (Ultimos 7 dias)</h2>
      <canvas id="dailyChart" height="120"></canvas>
    </article>
  </section>

  <section class="card">
    <h2>Resumo operacional</h2>
    <p>Periodo atual: <strong><%= selectedPeriod === "all" ? "Consolidado geral" : selectedPeriod %></strong>. Total de reservas no periodo: <strong><%= reservations.length %></strong>.</p>
  </section>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function () {
    var statusCtx = document.getElementById("statusChart");
    var methodCtx = document.getElementById("methodChart");
    var dailyCtx = document.getElementById("dailyChart");
    if (!statusCtx || !methodCtx || !dailyCtx || typeof Chart === "undefined") return;

    new Chart(statusCtx, {
      type: "doughnut",
      data: {
        labels: ["Pendentes", "Confirmadas", "Concluidas", "Canceladas"],
        datasets: [{ data: <%- JSON.stringify(safeCharts.status) %>, backgroundColor: ["#f59e0b", "#10b981", "#3b82f6", "#ef4444"] }]
      },
      options: { plugins: { legend: { position: "bottom" } } }
    });

    new Chart(methodCtx, {
      type: "bar",
      data: {
        labels: <%- JSON.stringify(safeCharts.methods.labels) %>,
        datasets: [{ label: "MT", data: <%- JSON.stringify(safeCharts.methods.values) %>, backgroundColor: "#ff6f3c", borderRadius: 8 }]
      },
      options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
    });

    new Chart(dailyCtx, {
      type: "line",
      data: {
        labels: <%- JSON.stringify(safeCharts.daily.labels) %>,
        datasets: [{ label: "Reservas", data: <%- JSON.stringify(safeCharts.daily.values) %>, borderColor: "#0da7a3", backgroundColor: "rgba(13,167,163,0.15)", fill: true, tension: 0.35 }]
      },
      options: { scales: { y: { beginAtZero: true } } }
    });
  })();
</script>
<%- include("../partials/footer") %>
